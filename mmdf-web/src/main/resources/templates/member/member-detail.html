<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會員資料管理</title>
    <style>
        #memberId, #birth, #twPersonId, #score {
            display: inline-block;
        }
    </style>
</head>
<body>
<h2>會員資料</h2>
<form id="memberForm">
    <div id="errorMessage" style="color: red;"></div>
    <div>
        <label for="memberId">會員編號：</label>
        <div id="memberId"></div>
    </div>
    <div>
        <label for="memberAccount">帳號：</label>
        <input type="text" id="memberAccount" name="memberAccount">
    </div>
    <div>
        <label for="name">姓名：</label>
        <input type="text" id="name" name="name">
    </div>
    <div>
        <label for="phone">電話：</label>
        <input type="tel" id="phone" name="phone">
    </div>
    <div>
        <label for="email">電子郵件：</label>
        <input type="email" id="email" name="email">
    </div>
    <div>
        <label for="birth">生日：</label>
        <div id="birth"></div>
    </div>
    <div>
        <label for="twPersonId">身份證字號：</label>
        <div id="twPersonId"></div>
    </div>
    <div>
        <label for="city">縣市：</label>
        <input type="text" id="city" name="city">
    </div>
    <div>
        <label for="address">地址：</label>
        <input type="text" id="address" name="address">
    </div>
    <div>
        <label for="score">我的評分：</label>
        <div id="score"></div>
    </div>
    <div>
        <button type="button" id="saveBtn">儲存</button>
    </div>
</form>
<script src="/js/vendor/jquery-3.7.1.min.js"></script>
<script src="/js/api-response-utils.js"></script>
<script>
    let userData = {};
    let errorMessage = "";

    function validateForm() {
        userData = {};
        errorMessage = "";
        let memberAccount = $("#memberAccount").val().trim();
        if (memberAccount === "" || !/^[A-Za-z0-9_]{2,20}$/.test(memberAccount)) {
            errorMessage += "<li>會員帳號必須是中、英文字母、數字和_，且長度必需在2到20之間</li>";
        }

        let name = $("#name").val().trim();
        if (name === "" || !/^[A-Za-z\u4e00-\u9fa5]{2,20}$/.test(name)) {
            errorMessage += "<li>姓名必須是中、英文字母，且長度必需在2到20之間</li>";
        }

        let phone = $("#phone").val().trim();
        if (phone === "" || !/^\d{10}$/.test(phone)) {
            errorMessage += "<li>電話必須是10位數字，且不含符號</li>";
        }

        let email = $("#email").val().trim();
        if (email === "" || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            errorMessage += "<li>請填寫正確的電子郵件格式</li>";
        }

        let city = $("#city").val().trim();
        if (city === "") {
            errorMessage += "<li>請填寫縣市</li>";
        }

        let address = $("#address").val().trim();
        if (address === "") {
            errorMessage += "<li>請填寫地址</li>";
        }

        // 如果有錯誤訊息，則顯示到 #errorMessage 中並回傳 false
        if (errorMessage !== "") {
            document.getElementById("errorMessage").innerHTML = "<ul>" + errorMessage + "</ul>";
            return false;
        }

        // 若所有檢查通過，設置好回傳的物件並回傳 true
        userData = {
            memberAccount: memberAccount,
            name: name,
            phone: phone,
            email: email,
            city: city,
            address: address
        };
        return true;
    }

    // 頁面載入完成，向後端請求會員資料並填入表單
    $.ajax({
        url: "/api/member/detail",
        method: "get",
        headers: {
            "authorization": localStorage.getItem("authorization")
        },
        success(response) {
            if (apiResponseJSON(response)) {
                $("#memberId").text(response.data.memberId);
                $("#memberAccount").val(response.data.memberAccount);
                $("#name").val(response.data.name);
                $("#phone").val(response.data.phone);
                $("#email").val(response.data.email);
                $("#birth").text(response.data.birth);
                $("#twPersonId").text(response.data.twPersonId);
                $("#city").val(response.data.city);
                $("#address").val(response.data.address);

                let scoreNumber = response.data.scoreNumber;
                let scoreSum = response.data.scoreSum;
                if (scoreNumber !== null) {
                    let number = parseInt(scoreNumber);
                    let sum = parseInt(scoreSum);
                    if (number !== 0) {
                        let score = sum / number;
                        $("#score").text(score);
                    }
                } else {
                    $("#score").text("無");
                }

                if (response.data.isVerified) {
                    $("#email").after('<span class="verified"> (已驗證)</span>');
                } else {
                    $("#email").after('<button type="button" onclick="sendVerifyEmail()"> 尚未驗證，點我發送驗證信</button>');
                }
            }
        },
        error(xhr, status, error) {
            alert("伺服器連線失敗: " + error);
        }
    });

    // 點擊儲存按鈕，向後端發送修改後的資料
    $("#saveBtn").click(function () {
        if (validateForm()) {
            $("#errorMessage").text("");
            $.ajax({
                url: "/api/member/edit",
                method: "post",
                headers: {
                    "authorization": localStorage.getItem("authorization")
                },
                contentType: "application/json",
                data: JSON.stringify(userData),
                success(response) {
                    if (apiResponseJSON(response)) {
                        alert("修改成功");
                        location.reload();
                    }
                },
                error(xhr, status, error) {
                    alert("伺服器連線失敗: " + error);
                }
            });
        }
    });

    function sendVerifyEmail() {
        $.ajax({
            url: "/api/member/sendVerifyEmail",
            method: "get",
            headers: {
                "authorization": localStorage.getItem("authorization")
            },
            success(response) {
                if (apiResponseJSON(response)) {
                    alert("發送成功");
                } else {
                    console.log(response);
                }
            },
            error(xhr, status, error) {
            }
        })
    }
</script>
</body>
</html>
